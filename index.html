<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>九五之猪</title>
  
  
  
  <!--link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.10.0/styles/github-gist.min.css"-->
  <link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.10.0/styles/github-gist.min.css">
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
<div class="Shell">
    <aside class='SideBar'>
    <section class='avatar' style="background-image: url(/assets/header.png)">
        <div class='av-pic' style="background-image: url(/assets/pig.jpg)">
        </div>
    </section>
    <section class='menu'>
        <div>九五之猪</div>
        
        <ul>
          
            <a href="/" class="Btn">
              <li>Home</li>
            </a>  
          
            <a href="/archives/" class="Btn">
              <li>Archive</li>
            </a>  
          
            <a href="/tags/" class="Btn">
              <li>Tags</li>
            </a>  
          
            <a href="/categories/" class="Btn">
              <li>Categories</li>
            </a>  
          
            <a href="/about/" class="Btn">
              <li>About</li>
            </a>  
          
        </ul>
    </section>
    <section class="media">
        
            
                <a href="https://github.com/haxisnake">
                    <img src="/assets/github.svg" />
                </a>
            
        
    </section>
</aside>

    <div class="container">
        <div data-pager-shell>
            <ul class="Index">
  
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/2020/12/01/TIDB源码学习笔记-DDL-CreateColumn时不同状态对Insert语句的影响/">TIDB源码学习笔记-DDL-CreateColumn时不同状态对Insert语句的影响</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2020-12-01T09:53:53.000Z" itemprop="datePublished">
    2020-12-01
  </time>
  
  | 
  <ul>
    
  <li class="meta-text">
  { <a href="/tags/TIDB/">TIDB</a> }
  </li>

  <li class="meta-text">
  { <a href="/tags/Golang/">Golang</a> }
  </li>


  </ul>
  
  
  / 
  <ul>
    
  <li class="meta-text">
  { <a href="/categories/学习笔记/">学习笔记</a> }
  </li>


  </ul>
  
</div>

    </header>
    <div>
      
        <p>Add Column会schema会经历none, delete-only, write-only, write-reorganization, public五个状态</p>
<p>当运行insert语句时，只有处于public状态的节点才会执行成功，其他状态的节点都会无法找到该列。</p>
<p>原因如下：</p>
<p>insert语句经过parse, 会由ExecuetStmt()-&gt;Compile()-&gt;Optimize()-&gt;optimize()-&gt;build()中的planBuilder.buildInsert()生成查询计划。</p>
<p>对于INSERT … VALUES … 会进入buildValuesListOfInsert()中：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *PlanBuilder)</span> <span class="title">buildInsert</span><span class="params">(ctx context.Context, insert *ast.InsertStmt)</span> <span class="params">(Plan, error)</span></span> &#123;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(insert.Setlist) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// Branch for `INSERT ... SET ...`.</span></span><br><span class="line">		err := b.buildSetValuesOfInsert(ctx, insert, insertPlan, mockTablePlan, checkRefColumn)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">len</span>(insert.Lists) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// Branch for `INSERT ... VALUES ...`.</span></span><br><span class="line">		err := b.buildValuesListOfInsert(ctx, insert, insertPlan, mockTablePlan, checkRefColumn)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// Branch for `INSERT ... SELECT ...`.</span></span><br><span class="line">		err := b.buildSelectPlanOfInsert(ctx, insert, insertPlan)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在buildValuesListOfInsert()中会由PlanBuilder.getAffectCols()确定实际要插入的列。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *PlanBuilder)</span> <span class="title">buildValuesListOfInsert</span><span class="params">(ctx context.Context, insert *ast.InsertStmt, insertPlan *Insert, mockTablePlan *LogicalTableDual, checkRefColumn <span class="keyword">func</span>(n ast.Node)</span> <span class="title">ast</span>.<span class="title">Node</span>) <span class="title">error</span></span> &#123;</span><br><span class="line">	affectedValuesCols, err := b.getAffectCols(insert, insertPlan)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><figcaption><span>planbuilder.go:2415:getAffectCols():</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *PlanBuilder)</span> <span class="title">getAffectCols</span><span class="params">(insertStmt *ast.InsertStmt, insertPlan *Insert)</span> <span class="params">(affectedValuesCols []*table.Column, err error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(insertStmt.Columns) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// This branch is for the following scenarios:</span></span><br><span class="line">		<span class="comment">// 1. `INSERT INTO tbl_name (col_name [, col_name] ...) &#123;VALUES | VALUE&#125; (value_list) [, (value_list)] ...`,</span></span><br><span class="line">		<span class="comment">// 2. `INSERT INTO tbl_name (col_name [, col_name] ...) SELECT ...`.</span></span><br><span class="line">		colName := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="number">0</span>, <span class="built_in">len</span>(insertStmt.Columns))</span><br><span class="line">		<span class="keyword">for</span> _, col := <span class="keyword">range</span> insertStmt.Columns &#123;</span><br><span class="line">			colName = <span class="built_in">append</span>(colName, col.Name.O)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">var</span> missingColName <span class="keyword">string</span></span><br><span class="line">		affectedValuesCols, missingColName = table.FindCols(insertPlan.Table.VisibleCols(), colName, insertPlan.Table.Meta().PKIsHandle)</span><br><span class="line">		<span class="keyword">if</span> missingColName != <span class="string">""</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, ErrUnknownColumn.GenWithStackByArgs(missingColName, clauseMsg[fieldList])</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">len</span>(insertStmt.Setlist) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// This branch is for the following scenarios:</span></span><br><span class="line">		<span class="comment">// 1. `INSERT INTO tbl_name &#123;VALUES | VALUE&#125; (value_list) [, (value_list)] ...`,</span></span><br><span class="line">		<span class="comment">// 2. `INSERT INTO tbl_name SELECT ...`.</span></span><br><span class="line">		affectedValuesCols = insertPlan.Table.VisibleCols()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> affectedValuesCols, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在确立AffectCols时是依据table的VisibleCols来确定的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VisibleCols implements table.Table VisibleCols interface.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *TableCommon)</span> <span class="title">VisibleCols</span><span class="params">()</span> []*<span class="title">table</span>.<span class="title">Column</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(t.VisibleColumns) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> t.VisibleColumns</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> t.getCols(visible)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *TableCommon)</span> <span class="title">getCols</span><span class="params">(mode getColsMode)</span> []*<span class="title">table</span>.<span class="title">Column</span></span> &#123;</span><br><span class="line">	columns := <span class="built_in">make</span>([]*table.Column, <span class="number">0</span>, <span class="built_in">len</span>(t.Columns))</span><br><span class="line">	<span class="keyword">for</span> _, col := <span class="keyword">range</span> t.Columns &#123;</span><br><span class="line">		<span class="keyword">if</span> col.State != model.StatePublic &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (mode == visible &amp;&amp; col.Hidden) || (mode == hidden &amp;&amp; !col.Hidden) &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		columns = <span class="built_in">append</span>(columns, col)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> columns</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据代码中的判断条件，如果列的状态不为StatePublic，那么就不会被归结为VisibleCols(), 也就不会被getAffectCols()所感知，Inser这一列的操作自然会报错。</p>

      
    </div>
</article>

    </li>
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/2020/11/26/TIDB源码学习笔记-Key编码后的比较/">TIDB源码学习笔记-Key编码后的比较</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2020-11-26T07:05:34.000Z" itemprop="datePublished">
    2020-11-26
  </time>
  
  | 
  <ul>
    
  <li class="meta-text">
  { <a href="/tags/TIDB/">TIDB</a> }
  </li>

  <li class="meta-text">
  { <a href="/tags/Golang/">Golang</a> }
  </li>


  </ul>
  
  
  / 
  <ul>
    
  <li class="meta-text">
  { <a href="/categories/学习笔记/">学习笔记</a> }
  </li>


  </ul>
  
</div>

    </header>
    <div>
      
        <p>key经过编码之后是字节数组，两个字节数组的比较方案如下所示：</p>
<p>判断两个字节数组的地址是否一样，如果一样则说明在同一段内存存储，直接判断长度，长度小的key编码较小。</p>
<p>如果首地址不一样，则按照两个数组的较小长度逐个元素比较，如有不同直接按照元素大小返回。</p>
<p>当在较小长度内所有元素都相同，则较大长度字节数组大于较小长度数组。如果两者长度相同且所有元素相同，则数组大小相同。</p>
<h2 id="example"><a href="#example" class="headerlink" title="example"></a>example</h2><p>例如有如下两个表：</p>
<p>table1, tableId为1, 第三列value含有索引，indexID为1<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rowid, name,        role, value</span><br><span class="line"><span class="number">1</span>,   <span class="string">"TiDB"</span>, <span class="string">"SQL Layer"</span>, <span class="number">10</span></span><br><span class="line"><span class="number">2</span>,   <span class="string">"TiKV"</span>, <span class="string">"KV Engine"</span>, <span class="number">20</span></span><br><span class="line"><span class="number">3</span>,     <span class="string">"PD"</span>,   <span class="string">"Manager"</span>, <span class="number">30</span></span><br></pre></td></tr></table></figure></p>
<p>table2, tableId为2, 第二列到第四列都含有索引，indexID从1到4<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rowid,   name, school, age, graduate date, personID(unique)</span><br><span class="line"><span class="number">1</span>, <span class="string">"XiaoMing"</span>, <span class="string">"A"</span>,     <span class="number">19</span>,    <span class="number">2020</span><span class="number">-06</span><span class="number">-20</span>, <span class="number">210283</span></span><br><span class="line"><span class="number">2</span>, <span class="string">"XiaoHong"</span>, <span class="string">"C"</span>,     <span class="number">19</span>,    <span class="number">2019</span><span class="number">-03</span><span class="number">-20</span>, <span class="number">270447</span></span><br><span class="line"><span class="number">3</span>, <span class="string">"XiaoWang"</span>, <span class="string">"B"</span>,     <span class="number">18</span>,    <span class="number">2018</span><span class="number">-07</span><span class="number">-01</span>, <span class="number">159668</span></span><br></pre></td></tr></table></figure></p>
<p>则其在Tikv中排布情况如下所示：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">t1_i1_intFlag&#123;<span class="number">10</span>&#125;_1 --&gt; null</span><br><span class="line">t1_i1_intFlag&#123;<span class="number">20</span>&#125;_2 --&gt; null</span><br><span class="line">t1_i1_intFlag&#123;<span class="number">30</span>&#125;_3 --&gt; null</span><br><span class="line">t1_r1 --&gt; [<span class="string">"TiDB"</span>, <span class="string">"SQL Layer"</span>, <span class="number">10</span>]</span><br><span class="line">t1_r2 --&gt; [<span class="string">"TiKV"</span>, <span class="string">"KV Engine"</span>, <span class="number">20</span>] </span><br><span class="line">t1_r3 --&gt; [<span class="string">"PD"</span>, <span class="string">"Manager"</span>, <span class="number">30</span>]</span><br><span class="line">t2_i1_bytesFlag&#123;A&#125;_1 --&gt; null</span><br><span class="line">t2_i1_bytesFlag&#123;B&#125;_3 --&gt; null</span><br><span class="line">t2_i1_bytesFlag&#123;C&#125;_2 --&gt; null</span><br><span class="line">t2_i2_uintFlag&#123;<span class="number">18</span>&#125;_3 --&gt; null</span><br><span class="line">t2_i2_uintFlag&#123;<span class="number">19</span>&#125;_1 --&gt; null</span><br><span class="line">t2_i2_uintFlag&#123;<span class="number">19</span>&#125;_2 --&gt; null</span><br><span class="line">t2_i3_uintFlag&#123;<span class="number">2018</span><span class="number">-07</span><span class="number">-01</span>&#125;_3 --&gt; null</span><br><span class="line">t2_i3_uintFlag&#123;<span class="number">2019</span><span class="number">-03</span><span class="number">-20</span>&#125;_2 --&gt; null</span><br><span class="line">t2_i3_uintFlag&#123;<span class="number">2020</span><span class="number">-06</span><span class="number">-20</span>&#125;_1 --&gt; null</span><br><span class="line">t2_i4_uintFlag&#123;<span class="number">159668</span>&#125; --&gt; <span class="number">3</span></span><br><span class="line">t2_i4_uintFlag&#123;<span class="number">210283</span>&#125; --&gt; <span class="number">1</span></span><br><span class="line">t2_i4_uintFlag&#123;<span class="number">270447</span>&#125; --&gt; <span class="number">2</span></span><br><span class="line">t2_r1 --&gt; [<span class="string">"XiaoMing"</span>, <span class="string">"A"</span>, <span class="number">19</span>, <span class="number">2020</span><span class="number">-06</span><span class="number">-20</span>]</span><br><span class="line">t2_r2 --&gt; [<span class="string">"XiaoHong"</span>, <span class="string">"B"</span>, <span class="number">19</span>, <span class="number">2019</span><span class="number">-03</span><span class="number">-20</span>]</span><br><span class="line">t2_r3 --&gt; [<span class="string">"XiaoWang"</span>, <span class="string">"C"</span>, <span class="number">18</span>, <span class="number">2018</span><span class="number">-07</span><span class="number">-01</span>]</span><br></pre></td></tr></table></figure></p>
<p>tikv是一个全局有序的分布式Key-Value引擎，因此，通过以上的设计可以让同一个表下同一个indexID的索引按照ColumnsValue分布到一段连续的区间上.这个columnsValue的编码方式主要在codec模块中。</p>
<p>columnsValue在进行实际的编码时，会在编码开始前添加一个codeFlag，如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    NilFlag          <span class="keyword">byte</span> = <span class="number">0</span></span><br><span class="line">    bytesFlag        <span class="keyword">byte</span> = <span class="number">1</span></span><br><span class="line">    compactBytesFlag <span class="keyword">byte</span> = <span class="number">2</span></span><br><span class="line">    intFlag          <span class="keyword">byte</span> = <span class="number">3</span></span><br><span class="line">    uintFlag         <span class="keyword">byte</span> = <span class="number">4</span></span><br><span class="line">    floatFlag        <span class="keyword">byte</span> = <span class="number">5</span></span><br><span class="line">    decimalFlag      <span class="keyword">byte</span> = <span class="number">6</span></span><br><span class="line">    durationFlag     <span class="keyword">byte</span> = <span class="number">7</span></span><br><span class="line">    varintFlag       <span class="keyword">byte</span> = <span class="number">8</span></span><br><span class="line">    uvarintFlag      <span class="keyword">byte</span> = <span class="number">9</span></span><br><span class="line">    jsonFlag         <span class="keyword">byte</span> = <span class="number">10</span></span><br><span class="line">    maxFlag          <span class="keyword">byte</span> = <span class="number">250</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>按照本人目前的理解，主要有两个作用：</p>
<ul>
<li><p>一是用来识别不同数据类型的编码方案。比如int64 compareble就会用intFlag标记，string compareable就会用bytesFlag来标记。</p>
</li>
<li><p>二是方便统一不同类型对于边界值处理。在tidb中任何类型都有三个较为特殊的值，Null, MinNotNull, MaxValue.它主要用来表示一些筛选条件的range边界。这三个值的codeFlag是：</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Null       --&gt; NilFlag <span class="keyword">byte</span> = <span class="number">0</span></span><br><span class="line">MinNotNull --&gt; bytesFlag <span class="keyword">byte</span> = <span class="number">1</span></span><br><span class="line">MaxValue   --&gt; maxFlag <span class="keyword">byte</span> = <span class="number">250</span></span><br></pre></td></tr></table></figure>
<p>比如 <code>select * from table1 where value &lt; 15</code> 这样一个查询， value的range就是[MinNotNull, 15). 对于这三个特殊值，并不依据具体的类型做编码，而是通过codeFlag这个字节来标识。结合key的编码比较方案，就可以实现对range边界的确定。</p>
<p>例如</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">from</span> * <span class="keyword">from</span> table2 <span class="keyword">where</span> school &lt;= <span class="string">"B"</span> <span class="keyword">AND</span> school <span class="keyword">is</span> <span class="keyword">Not</span> <span class="literal">Null</span></span><br></pre></td></tr></table></figure>
<p>这样一个查询, 生成的range就是:<br><code>[MaxNotNull, &quot;B&quot;]</code><br>对应到tikv中的key编码就是:<br><code>[t2_i1_bytesFlag, t2_i1_bytesFlag{B}]</code><br>而包含Null的查询:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">from</span> * <span class="keyword">from</span> table2 <span class="keyword">where</span> school &lt;= <span class="string">"B"</span></span><br></pre></td></tr></table></figure></p>
<p>这样一个查询, 生成的range就是:<br><code>[Null, &quot;B&quot;]</code><br>对应到tikv中的key编码就是:<br><code>[t2_i1_NilFlag, t2_i1_bytesFlag{B}]</code></p>

      
    </div>
</article>

    </li>
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/2020/11/18/TIDB源码学习笔记-range的生成/">TIDB源码学习笔记-range的生成</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2020-11-18T07:10:19.000Z" itemprop="datePublished">
    2020-11-18
  </time>
  
  | 
  <ul>
    
  <li class="meta-text">
  { <a href="/tags/TIDB/">TIDB</a> }
  </li>

  <li class="meta-text">
  { <a href="/tags/Golang/">Golang</a> }
  </li>


  </ul>
  
  
  / 
  <ul>
    
  <li class="meta-text">
  { <a href="/categories/学习笔记/">学习笔记</a> }
  </li>


  </ul>
  
</div>

    </header>
    <div>
      
        <h2 id="point"><a href="#point" class="headerlink" title="point"></a>point</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Point is the end point of range interval.</span></span><br><span class="line"><span class="keyword">type</span> point <span class="keyword">struct</span> &#123;</span><br><span class="line">    value types.Datum</span><br><span class="line">    excl  <span class="keyword">bool</span> <span class="comment">// exclude</span></span><br><span class="line">    start <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ranger"><a href="#ranger" class="headerlink" title="ranger"></a>ranger</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RangeType is alias for int.</span></span><br><span class="line"><span class="keyword">type</span> RangeType <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// RangeType constants.</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    IntRangeType RangeType = <span class="literal">iota</span></span><br><span class="line">    ColumnRangeType</span><br><span class="line">    IndexRangeType</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Range represents a range generated in physical plan building phase.</span></span><br><span class="line"><span class="keyword">type</span> Range <span class="keyword">struct</span> &#123;</span><br><span class="line">    LowVal  []types.Datum</span><br><span class="line">    HighVal []types.Datum</span><br><span class="line"></span><br><span class="line">    LowExclude  <span class="keyword">bool</span> <span class="comment">// Low value is exclusive.</span></span><br><span class="line">    HighExclude <span class="keyword">bool</span> <span class="comment">// High value is exclusive.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// fullRange is (-∞, +∞).</span></span><br><span class="line"><span class="keyword">var</span> fullRange = []point&#123;</span><br><span class="line">    &#123;start: <span class="literal">true</span>&#125;,</span><br><span class="line">    &#123;value: types.MaxValueDatum()&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FullIntRange unsigned [<span class="number">0</span>, MaxUint64] signed [MinInt64, MaxInt64]</span><br><span class="line">FullRange [,MaxValueDatum) [null, +∞)</span><br><span class="line">FullNotNullRange (MinNotNullDatum, MaxValueDatum) (-∞, +∞)</span><br><span class="line">NullRange [,] [null, null]</span><br></pre></td></tr></table></figure>
<h2 id="单列range生成过程"><a href="#单列range生成过程" class="headerlink" title="单列range生成过程"></a>单列range生成过程</h2><ul>
<li>通过builder将expression转化为[]point.主要的转化逻辑如下表所示：</li>
</ul>
<table>
<thead>
<tr>
<th>method</th>
<th>return</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>buildFromColumn</td>
<td>[-inf, 0) (0, +inf]</td>
<td>列名表达式等价于列名为真。</td>
</tr>
<tr>
<td>buildFromConstant</td>
<td>nil 或者 fullRange</td>
<td>当常量Eval转化出错，或者常量为Null或者常量为0时，返回nil，否则返回fullRange</td>
</tr>
<tr>
<td>buildFromScalarFunc</td>
<td>—</td>
<td></td>
</tr>
<tr>
<td>buildFromBinOp</td>
<td>a==NULL [,] a==1 [1, 1] <br> a!=1 [-inf, 1) (1, +inf]) <br> a&gt;1 (1, +inf]</td>
</tr>
<tr>
<td>ast.LogicAnd</td>
<td></td>
<td>取交集 </td>
</tr>
<tr>
<td>ast.LogicOr</td>
<td></td>
<td>取并集 取交集和取并集通过merge实现，通过flag区分。merge函数的假设：<br> <em> a, b 两个区间均已经做过去重<br> </em> 单个区间序列内部不会有重叠的部分</td>
</tr>
<tr>
<td>buildFromIsTrue</td>
<td>[-inf, 0) (0, +inf]</td>
<td>还有包含is not和with null的处理</td>
</tr>
<tr>
<td>buildFromIsFalse</td>
<td>[0, 0]</td>
<td>还有包含is not的处理</td>
</tr>
<tr>
<td>buildFromIn</td>
<td>a in (1, 2, 3) <br> {[1, 1], [2, 2], [3, 3]}</td>
<td>对每个点生成一个rangePoint，然后排序去重。</td>
</tr>
<tr>
<td>buildFromPatternLike</td>
<td>a LIKE ‘abc%’ [abc, abd) <br> a LIKE ‘abc_’ (abc, abd)</td>
<td>找前缀然后再计算起始点和终止点。</td>
</tr>
<tr>
<td>isNull</td>
<td>[,]</td>
</tr>
<tr>
<td>buildFromNot</td>
<td></td>
<td>对于Not前缀的处理</td>
</tr>
</tbody>
</table>
<ul>
<li><p>通过points2TableRanges和points2Ranges将point转化为range.</p>
<p>  对于TableRange, 会将points中的null移除，同时将MinNotNull转化为MinInt64或者MinUint64, MaxValue转化为MaxInt64或者MaxUint64</p>
<p>  再将point转化为range时，会将point转化为对应的FieldType，并将转化后的数据与原数据作比较，以此来修正point的excl属性，这部分逻辑在convertPoint中。举例 “a &gt; 1.9” 在1.9转化为整形时会变为“a&gt;=2”.</p>
<p>  不同数据的比较逻辑放在datum.go中的CompareDatum中，比较特殊的几个类型的大小关系如下所示：</p>
<ul>
<li>MinNotNullDatum用来表示最小值即-inf</li>
<li>MaxValueDatum用来表示最大值即+inf</li>
<li><p>Null &lt; MinNotNull &lt; 其他类型的具体值 &lt; MaxValue</p>
<p>如果column无Null值，那么会移除[null, null]这样的range.</p>
</li>
</ul>
</li>
<li><p>得到range之后，对于Column，会尝试进行range的裁剪和range的合并</p>
<ul>
<li><p>range裁剪的应用场景猜测：</p>
<p>  对于string列和bytes列，其有一定长度，比如col1 VarChar(6), 如果range中的端点长度超过这个值，即15，比如col1 &gt; “12345678”,那么这个端点就会被裁剪为 col1 &gt;= “123456”</p>
</li>
<li><p>range 合并场景：</p>
<p>  [a, b] [c, d] 如果a &lt;= c 并且b &gt;= c，那么这两个区间就可以合并为[a, max(b, d)]</p>
</li>
</ul>
</li>
</ul>

      
    </div>
</article>

    </li>
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/2020/11/12/TIDB源码学习笔记-row的编码格式/">TIDB源码学习笔记-row的编码格式</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2020-11-12T07:12:50.000Z" itemprop="datePublished">
    2020-11-12
  </time>
  
  | 
  <ul>
    
  <li class="meta-text">
  { <a href="/tags/TIDB/">TIDB</a> }
  </li>

  <li class="meta-text">
  { <a href="/tags/Golang/">Golang</a> }
  </li>


  </ul>
  
  
  / 
  <ul>
    
  <li class="meta-text">
  { <a href="/categories/学习笔记/">学习笔记</a> }
  </li>


  </ul>
  
</div>

    </header>
    <div>
      
        <h1 id="方案一-实现在util-rowcodec"><a href="#方案一-实现在util-rowcodec" class="headerlink" title="方案一 实现在util/rowcodec"></a>方案一 实现在util/rowcodec</h1><p>会记录当前行的空置和非空值数量</p>
<p>如果总列数大于255，会用uint32存储column id,否则使用byte存储column id.</p>
<p>会将同一行非空列排布在前面，空值列排布在后面，分别按照column id进行排序。 每一个非空列column id对应一个value.<br>空值列的column id对应的value位置没有value重新赋值的操作。</p>
<p>会有一个notNullIdx来区分非空列和空列的界限。</p>
<p>最后转化为bytes的结构</p>
<ul>
<li>CodecVer: 1 byte</li>
<li>flag: 1 byte : large 1 small 0 </li>
<li>numNotNullCols: 2 bytes</li>
<li>numNullCols: 2 bytes</li>
<li>colIDs32: uint32[] 转 byte[], 如果是small则为colIDs byte[]</li>
<li>offsets32:  uint32[] 转 byte[],  如果是small则为sffsets u16[] 转 byte[]</li>
<li>data: byte[]<h1 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h1></li>
</ul>
<p>这套方案比较简单，申请row长度2倍的datum数组，前面用来存储数值，后面用来存储column id 一一对应。</p>

      
    </div>
</article>

    </li>
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/2020/11/06/TIDB源码学习笔记-基本类型编解码方案/">TIDB源码学习笔记-基本类型编解码方案</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2020-11-06T08:59:13.000Z" itemprop="datePublished">
    2020-11-06
  </time>
  
  | 
  <ul>
    
  <li class="meta-text">
  { <a href="/tags/TIDB/">TIDB</a> }
  </li>

  <li class="meta-text">
  { <a href="/tags/Golang/">Golang</a> }
  </li>


  </ul>
  
  
  / 
  <ul>
    
  <li class="meta-text">
  { <a href="/categories/学习笔记/">学习笔记</a> }
  </li>


  </ul>
  
</div>

    </header>
    <div>
      
        <h1 id="TIDB基本类型的编码方案"><a href="#TIDB基本类型的编码方案" class="headerlink" title="TIDB基本类型的编码方案"></a>TIDB基本类型的编码方案</h1><p>TIDB在编码不同的数据类型时会在编码前部添加一个字节的Flag用来区分不同的编码方案。同时，TIDB支持具有Memcomparable特性的编码，Memcomparable是指保证编码前和编码后的比较关系不变。在TIDB中，对于Key的编码都是要求Memcomparable的，而对于Value的编码则不要求Memcomparable，可以采用更节省空间的编码方案。</p>
<p>在进行编码前，会先依据数据类型预先申请一定尺寸的byte，然后再进行编码。</p>
<p>如下是目前的Flag，用于标识不同的编码方案<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    NilFlag          <span class="keyword">byte</span> = <span class="number">0</span></span><br><span class="line">    bytesFlag        <span class="keyword">byte</span> = <span class="number">1</span></span><br><span class="line">    compactBytesFlag <span class="keyword">byte</span> = <span class="number">2</span></span><br><span class="line">    intFlag          <span class="keyword">byte</span> = <span class="number">3</span></span><br><span class="line">    uintFlag         <span class="keyword">byte</span> = <span class="number">4</span></span><br><span class="line">    floatFlag        <span class="keyword">byte</span> = <span class="number">5</span></span><br><span class="line">    decimalFlag      <span class="keyword">byte</span> = <span class="number">6</span></span><br><span class="line">    durationFlag     <span class="keyword">byte</span> = <span class="number">7</span></span><br><span class="line">    varintFlag       <span class="keyword">byte</span> = <span class="number">8</span></span><br><span class="line">    uvarintFlag      <span class="keyword">byte</span> = <span class="number">9</span></span><br><span class="line">    jsonFlag         <span class="keyword">byte</span> = <span class="number">10</span></span><br><span class="line">    maxFlag          <span class="keyword">byte</span> = <span class="number">250</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>下表是数据类型与Flag的对应关系以及相应的编码尺寸计算方法，具体的编码方案会在后续一一展开。</p>
<img src="/2020/11/06/TIDB源码学习笔记-基本类型编解码方案/encode.png">
<h1 id="INT64"><a href="#INT64" class="headerlink" title="INT64"></a>INT64</h1><h2 id="comparable"><a href="#comparable" class="headerlink" title="comparable"></a>comparable</h2><p>这种方式保证编码后的二进制排序结果与编码前的是完全相同的。</p>
<p>编码方法:  uint64(num) ^ signMask </p>
<p>const signMask uint64 = 0x8000000000000000</p>
<table>
<thead>
<tr>
<th>signed int</th>
<th>binary</th>
<th>after code</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>0000 0000 0000 0001</td>
<td>1000 0000 0000 0001</td>
</tr>
<tr>
<td>0</td>
<td>0000 0000 0000 0001</td>
<td>1000 0000 0000 0001</td>
</tr>
<tr>
<td>-1</td>
<td>1111 1111 1111 1111</td>
<td>0111 1111 1111 1111</td>
</tr>
<tr>
<td>-2</td>
<td>1111 1111 1111 1110</td>
<td>0111 1111 1111 1110</td>
</tr>
</tbody>
</table>
<h2 id="uncomparable"><a href="#uncomparable" class="headerlink" title="uncomparable:"></a>uncomparable:</h2><p>这种方法不能保证编码后是严格有序的。</p>
<p>编码方法: PutVarint函数</p>
<p>PutVarint:</p>
<p>步骤一：左移去掉符号位,如果是负数则对移位后的数取反</p>
<p>步骤二：将得到的数字从低到高每七位放入一个字节中，字节的第一位表示是否有后续字节。</p>
<p>举例：</p>
<table>
<thead>
<tr>
<th>原始数据</th>
<th>16进制表示</th>
<th>步骤一结果</th>
<th>步骤二结果</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>0x1</td>
<td>0x02</td>
<td>0x02</td>
</tr>
<tr>
<td>-1</td>
<td>0xffffffffffffffff</td>
<td>0x01</td>
<td>0x01</td>
</tr>
<tr>
<td>128</td>
<td>0x80</td>
<td>0x0100</td>
<td>0x8002</td>
</tr>
<tr>
<td>127</td>
<td>0x7f</td>
<td>0xfe</td>
<td>0xfe01</td>
</tr>
</tbody>
</table>
<h1 id="Uint64"><a href="#Uint64" class="headerlink" title="Uint64"></a>Uint64</h1><h2 id="comparable-1"><a href="#comparable-1" class="headerlink" title="comparable"></a>comparable</h2><p>直接写入二进制</p>
<h2 id="uncomparable-1"><a href="#uncomparable-1" class="headerlink" title="uncomparable"></a>uncomparable</h2><p>将二进制表示从低到高每七位放入一个字节中，字节的第一位表示是否有后续字节，其实就是去掉int64的uncomparable中符号处理那一步后剩下的步骤。</p>
<h1 id="Float32-Float64"><a href="#Float32-Float64" class="headerlink" title="Float32 Float64"></a>Float32 Float64</h1><p>Go的浮点数是按照IEEE 754浮点数标准存储的，TIDB直接对二进制表示进行操作</p>
<p>将正浮点数的符号位置1，将负浮点数的二进制表示按位取反</p>
<p>这样编码后的二进制是先比较符号位，再比较指数位，最后比较小数位，就可以保证编码值是升序的。对于负浮点数的比较因为是进行了取反，所以也能保证是升序的。如果要降序只要将编码值取反即可。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">encodeFloatToCmpUint64</span><span class="params">(f <span class="keyword">float64</span>)</span> <span class="title">uint64</span></span> &#123;</span><br><span class="line">    u := math.Float64bits(f)</span><br><span class="line">    <span class="keyword">if</span> f &gt;= <span class="number">0</span> &#123;</span><br><span class="line">        u |= signMask</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        u = ^u </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> u</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Byte"><a href="#Byte" class="headerlink" title="Byte"></a>Byte</h1><h2 id="comparable-2"><a href="#comparable-2" class="headerlink" title="comparable"></a>comparable</h2><p>[group1][marker1]…[groupN][markerN]</p>
<p>group 是补零之后的8字节切片</p>
<p>markder = 0xFF - 补零数量</p>
<p>举例:</p>
<pre><code>[] -&gt; [0, 0, 0, 0, 0, 0, 0, 0, 247]

[1, 2, 3] -&gt; [1, 2, 3, 0, 0, 0, 0, 0, 250]

[1, 2, 3, 0] -&gt; [1, 2, 3, 0, 0, 0, 0, 0, 251]

[1, 2, 3, 4, 5, 6, 7, 8] -&gt; [1, 2, 3, 4, 5, 6, 7, 8, 255, 0, 0, 0, 0, 0, 0, 0, 0, 247]
</code></pre><h2 id="uncomparable-2"><a href="#uncomparable-2" class="headerlink" title="uncomparable"></a>uncomparable</h2><p>数据长度 + 实际数据的二进制</p>
<h1 id="String"><a href="#String" class="headerlink" title="String"></a>String</h1><p>如果有排序规则，则使用排序规则得到的Bytes，否则直接用String本身的Bytes<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">encodeString</span><span class="params">(b []<span class="keyword">byte</span>, val types.Datum, comparable <span class="keyword">bool</span>)</span> []<span class="title">byte</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> collate.NewCollationEnabled() &amp;&amp; comparable &#123;</span><br><span class="line">        <span class="keyword">return</span> encodeBytes(b, collate.GetCollator(val.Collation()).Key(val.GetString()), <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> encodeBytes(b, val.GetBytes(), comparable)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="MysqlTime"><a href="#MysqlTime" class="headerlink" title="MysqlTime"></a>MysqlTime</h1><p>先进行时区转化，全部转换为UTC时区后将Time转为uint64，再以uint64的形式进行编码。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ToPackedUint encodes Time to a packed uint64 value.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    1 bit  0</span></span><br><span class="line"><span class="comment">//   17 bits year*13+month   (year 0-9999, month 0-12)</span></span><br><span class="line"><span class="comment">//    5 bits day             (0-31)</span></span><br><span class="line"><span class="comment">//    5 bits hour            (0-23)</span></span><br><span class="line"><span class="comment">//    6 bits minute          (0-59)</span></span><br><span class="line"><span class="comment">//    6 bits second          (0-59)</span></span><br><span class="line"><span class="comment">//   24 bits microseconds    (0-999999)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//   Total: 64 bits = 8 bytes</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//   0YYYYYYY.YYYYYYYY.YYdddddh.hhhhmmmm.mmssssss.ffffffff.ffffffff.ffffffff</span></span><br></pre></td></tr></table></figure></p>
<h1 id="MysqlDuration"><a href="#MysqlDuration" class="headerlink" title="MysqlDuration"></a>MysqlDuration</h1><p>duration可能有负值，所以无法直接用string来进行编码，采用的是同Int comparable相同的编码。</p>
<h1 id="MysqlDecimal"><a href="#MysqlDecimal" class="headerlink" title="MysqlDecimal"></a>MysqlDecimal</h1><p>编码方式： precision + frac + WriteBin函数</p>
<p>WriteBin: 每 9 位十进制数字包装成 4 个字节. 其中整数和小数部分分别确定所需的存储空间. 如果数字位数为 9 的倍数, 则每 9 位十进制数字各采用 4 个字节进行存储, 对于剩余不足 9 位的数字, 所需的存储空间如下表所示：</p>
<table>
<thead>
<tr>
<th>剩余数字位数</th>
<th>存储所需字节数</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1-2</td>
<td>1</td>
</tr>
<tr>
<td>3-4</td>
<td>2</td>
</tr>
<tr>
<td>5-6</td>
<td>3</td>
</tr>
<tr>
<td>7-9</td>
<td>4</td>
</tr>
</tbody>
</table>
<p>举例：</p>
<p>1234567890.1234</p>
<p>以9位数字以及小数点为边界，可将decimal类型拆分为如下所示：</p>
<pre><code>1 234567890 123400000
</code></pre><p>假设存储位数为有效位数为14，小数位为4，使用16进制表示为三部分：</p>
<pre><code>00-00-00-01  0D-FB-38-D2  07-5A-EF-40
</code></pre><p>现在，中间部分已经是被填满，它存储了9位的十进制数字：</p>
<pre><code>............  0D-FB-38-D2  ............
</code></pre><p>第一部分只有一个十进制数字，所以我们可以只用一个字节来存储，而不必浪费四个字节：</p>
<pre><code>01 0D-FB-38-D2 ............
</code></pre><p>现在，最后一部分，它是123400000，我们可以用两个字节来存储：</p>
<pre><code>01 0D-FB-38-D2 04-D2
</code></pre><p>因此，我们将一个12个字节的数字使用7字节进行了表示，现在需要将最高位反转来得到最后的结果：</p>
<pre><code>81 0D FB 38 D2 04 D2
</code></pre><p>如果要表示 -1234567890.1234，需要将各个位取反：</p>
<pre><code>7E F2 04 C7 2D FB 2D
</code></pre><p>最高位反转，是为了保证有相同有效位数和有效小数位的DECIMAL类型编码后的二进制具有comparable特性。原因如下：</p>
<p>首先，最高位的置不影响原先数值的表示，因为不管第一部分剩多少位数字，它永远不会取到最高位，所以正数的DECIMAL类型的comparable可以得到保证。</p>
<p>其次，通过最高位置1再反转的形式，可以保证所有的负数的二进制编码都小于正数的二进制编码，即保证了正数和负数二进制编码之间的comparable。</p>
<p>最后，负数编码的comparable则是通过将正数编码所有位取反保证的。</p>
<h1 id="MysqlEnum-MysqlSet-MysqlBit-BinaryLiteral"><a href="#MysqlEnum-MysqlSet-MysqlBit-BinaryLiteral" class="headerlink" title="MysqlEnum MysqlSet MysqlBit BinaryLiteral"></a>MysqlEnum MysqlSet MysqlBit BinaryLiteral</h1><p>通过各自的ToNumber或者ToInt方法转化为uint64进行编码</p>
<h1 id="MysqlJSON"><a href="#MysqlJSON" class="headerlink" title="MysqlJSON"></a>MysqlJSON</h1><p>TypeCode + Value</p>
<p>TypeCode:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TypeCodeObject indicates the JSON is an object.</span></span><br><span class="line">TypeCodeObject TypeCode = <span class="number">0x01</span></span><br><span class="line"><span class="comment">// TypeCodeArray indicates the JSON is an array.</span></span><br><span class="line">TypeCodeArray TypeCode = <span class="number">0x03</span></span><br><span class="line"><span class="comment">// TypeCodeLiteral indicates the JSON is a literal.</span></span><br><span class="line">TypeCodeLiteral TypeCode = <span class="number">0x04</span></span><br><span class="line"><span class="comment">// TypeCodeInt64 indicates the JSON is a signed integer.</span></span><br><span class="line">TypeCodeInt64 TypeCode = <span class="number">0x09</span></span><br><span class="line"><span class="comment">// TypeCodeUint64 indicates the JSON is a unsigned integer.</span></span><br><span class="line">TypeCodeUint64 TypeCode = <span class="number">0x0a</span></span><br><span class="line"><span class="comment">// TypeCodeFloat64 indicates the JSON is a double float number.</span></span><br><span class="line">TypeCodeFloat64 TypeCode = <span class="number">0x0b</span></span><br><span class="line"><span class="comment">// TypeCodeString indicates the JSON is a string.</span></span><br><span class="line">TypeCodeString TypeCode = <span class="number">0x0c</span></span><br><span class="line"></span><br><span class="line">Value []<span class="keyword">byte</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Null"><a href="#Null" class="headerlink" title="Null"></a>Null</h2><p>NilFlag</p>
<h2 id="MinNotNull"><a href="#MinNotNull" class="headerlink" title="MinNotNull"></a>MinNotNull</h2><p>bytesFlag</p>
<h2 id="MaxValue"><a href="#MaxValue" class="headerlink" title="MaxValue"></a>MaxValue</h2><p>maxFlag</p>
<h1 id="编码模块位置"><a href="#编码模块位置" class="headerlink" title="编码模块位置"></a>编码模块位置</h1><ul>
<li>util/codec</li>
<li>tablecodec</li>
<li>util/rowcodec</li>
</ul>

      
    </div>
</article>

    </li>
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/2019/10/25/二叉树的遍历方法总结/">二叉树的遍历方法总结</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2019-10-25T08:46:35.000Z" itemprop="datePublished">
    2019-10-25
  </time>
  
  | 
  <ul>
    
  <li class="meta-text">
  { <a href="/tags/数据结构/">数据结构</a> }
  </li>


  </ul>
  
  
</div>

    </header>
    <div>
      
        <h1 id="二叉树的遍历方法总结"><a href="#二叉树的遍历方法总结" class="headerlink" title="二叉树的遍历方法总结"></a>二叉树的遍历方法总结</h1><p>二叉树的遍历有前序遍历，中序遍历，后续遍历和层序遍历，这几种方法都可以通过递归和循环来实现。</p>
<h2 id="二叉树数据结构定义"><a href="#二叉树数据结构定义" class="headerlink" title="二叉树数据结构定义"></a>二叉树数据结构定义</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Definition for a binary tree node.</span></span><br><span class="line"><span class="comment">* struct TreeNode &#123;</span></span><br><span class="line"><span class="comment">*     int val;</span></span><br><span class="line"><span class="comment">*     TreeNode *left;</span></span><br><span class="line"><span class="comment">*     TreeNode *right;</span></span><br><span class="line"><span class="comment">*     TreeNode(int x) : val(x), left(NULL), right(NULL) &#123;&#125;</span></span><br><span class="line"><span class="comment">* &#125;;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h2 id="二叉树的前序遍历"><a href="#二叉树的前序遍历" class="headerlink" title="二叉树的前序遍历"></a>二叉树的前序遍历</h2><ul>
<li><p>递归实现</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; preorderTraversal(TreeNode* root) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!root)&#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; res;</span><br><span class="line">        preorderTraversal(root,res);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">preorderTraversal</span><span class="params">(TreeNode* root, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; res)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!root)&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        res.push_back(root-&gt;val);</span><br><span class="line">        preorderTraversal(root-&gt;left,res);</span><br><span class="line">        preorderTraversal(root-&gt;right,res);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>循环实现</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; preorderTraversal(TreeNode* root) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!root)&#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; res;</span><br><span class="line">        <span class="built_in">stack</span>&lt;TreeNode*&gt; nodes;</span><br><span class="line">        nodes.push(root);</span><br><span class="line">        <span class="keyword">while</span>(!nodes.empty())&#123;</span><br><span class="line">            TreeNode* node = nodes.top();</span><br><span class="line">            nodes.pop();</span><br><span class="line">            res.push_back(node-&gt;val);</span><br><span class="line">            <span class="keyword">if</span>(node-&gt;right)&#123;</span><br><span class="line">                nodes.push(node-&gt;right);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(node-&gt;left)&#123;</span><br><span class="line">                nodes.push(node-&gt;left);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="二叉树的中序遍历"><a href="#二叉树的中序遍历" class="headerlink" title="二叉树的中序遍历"></a>二叉树的中序遍历</h2><ul>
<li><p>递归实现</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; inorderTraversal(TreeNode* root) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!root) <span class="keyword">return</span>&#123;&#125;;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; res;</span><br><span class="line">        inorderTraversal(root,res);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inorderTraversal</span><span class="params">(TreeNode* root, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; res)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!root)&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        inorderTraversal(root-&gt;left, res);</span><br><span class="line">        res.push_back(root-&gt;val);</span><br><span class="line">        inorderTraversal(root-&gt;right,res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>循环实现</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; inorderTraversal(TreeNode* root) &#123;</span><br><span class="line">        <span class="built_in">stack</span>&lt;TreeNode*&gt; s;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; res;</span><br><span class="line">        TreeNode* r = root;</span><br><span class="line">        <span class="keyword">while</span>(!s.empty() || r!=<span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="keyword">while</span>(r!=<span class="literal">NULL</span>)&#123;</span><br><span class="line">                s.push(r);</span><br><span class="line">                r = r-&gt;left;</span><br><span class="line">            &#125;</span><br><span class="line">            r = s.top();</span><br><span class="line">            s.pop();</span><br><span class="line">            res.push_back(r-&gt;val);</span><br><span class="line">            r=r-&gt;right;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="二叉树的后序遍历"><a href="#二叉树的后序遍历" class="headerlink" title="二叉树的后序遍历"></a>二叉树的后序遍历</h2><ul>
<li><p>递归实现</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; postorderTraversal(TreeNode* root) &#123;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; res;</span><br><span class="line">        <span class="keyword">if</span>(!root) <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">        postorderTraversal(root,res);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">postorderTraversal</span><span class="params">(TreeNode* root, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; res)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!root)&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        postorderTraversal(root-&gt;left,res);</span><br><span class="line">        postorderTraversal(root-&gt;right,res);</span><br><span class="line">        res.push_back(root-&gt;val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>循环实现</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; postorderTraversal(TreeNode* root) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!root) <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">        <span class="built_in">stack</span>&lt;TreeNode*&gt; nodes;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; res;</span><br><span class="line">        TreeNode* pre = <span class="literal">NULL</span>;</span><br><span class="line">        nodes.push(root);</span><br><span class="line">        <span class="keyword">while</span>(!nodes.empty())&#123;</span><br><span class="line">            TreeNode* node = nodes.top();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>( (node-&gt;left==<span class="literal">NULL</span> &amp;&amp; node-&gt;right==<span class="literal">NULL</span>) || </span><br><span class="line">                (pre!=<span class="literal">NULL</span> &amp;&amp; (node-&gt;left==pre || node-&gt;right==pre)))&#123;</span><br><span class="line">                pre = node;</span><br><span class="line">                res.push_back(node-&gt;val);</span><br><span class="line">                nodes.pop();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(node-&gt;right)&#123;</span><br><span class="line">                    nodes.push(node-&gt;right);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(node-&gt;left)&#123;</span><br><span class="line">                    nodes.push(node-&gt;left);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;            </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="二叉树的层序遍历"><a href="#二叉树的层序遍历" class="headerlink" title="二叉树的层序遍历"></a>二叉树的层序遍历</h2><ul>
<li><p>递归实现</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&gt; levelOrder(TreeNode* root) &#123;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &gt; res;</span><br><span class="line">        <span class="keyword">if</span>(root==<span class="literal">NULL</span>) <span class="keyword">return</span> res;</span><br><span class="line">        levelOrder(root,res,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">levelOrder</span><span class="params">(TreeNode* root, <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &gt;&amp;res, <span class="keyword">int</span> level)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root==<span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span>(res.size()==level)&#123;</span><br><span class="line">            res.push_back(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;(<span class="number">1</span>,root-&gt;val));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            res[level].push_back(root-&gt;val);</span><br><span class="line">        &#125;</span><br><span class="line">        levelOrder(root-&gt;left,res,level+<span class="number">1</span>);</span><br><span class="line">        levelOrder(root-&gt;right,res,level+<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>循环实现</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&gt; levelOrder(TreeNode* root) &#123;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &gt; res;</span><br><span class="line">        <span class="keyword">if</span>(!root) <span class="keyword">return</span> res;</span><br><span class="line">        <span class="built_in">queue</span>&lt;TreeNode*&gt; nodes;</span><br><span class="line">        nodes.push(root);</span><br><span class="line">        <span class="keyword">int</span> level=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(!nodes.empty())&#123;</span><br><span class="line">            <span class="keyword">int</span> level_size = nodes.size();</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            res.push_back(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;(<span class="number">0</span>));</span><br><span class="line">            <span class="keyword">while</span>(count&lt;level_size)&#123;</span><br><span class="line">                TreeNode* node = nodes.front();</span><br><span class="line">                nodes.pop();</span><br><span class="line">                res[level].push_back(node-&gt;val);</span><br><span class="line">                count++;</span><br><span class="line">                <span class="keyword">if</span>(node-&gt;left)&#123;</span><br><span class="line">                    nodes.push(node-&gt;left);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(node-&gt;right)&#123;</span><br><span class="line">                    nodes.push(node-&gt;right);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            level++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>
</article>

    </li>
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/2019/05/29/设置linux开机启动脚本自动联网认证/">设置linux开机启动脚本自动联网认证</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2019-05-29T13:59:42.000Z" itemprop="datePublished">
    2019-05-29
  </time>
  
  | 
  <ul>
    
  <li class="meta-text">
  { <a href="/tags/服务器维护/">服务器维护</a> }
  </li>


  </ul>
  
  
</div>

    </header>
    <div>
      
        <p>由于学校的网络需要认证上网,每次服务器上网都用个人账号认证，因此需要配置下开机启动脚本使其自动上网。(其实就是没钱惹的祸)</p>
<h1 id="一、上网认证的脚本"><a href="#一、上网认证的脚本" class="headerlink" title="一、上网认证的脚本"></a>一、上网认证的脚本</h1><p>先安装依赖:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install python-pip</span><br><span class="line">sudo pip3 install schedule </span><br><span class="line">sudo pip3 install argparse</span><br></pre></td></tr></table></figure></p>
<figure class="highlight python"><figcaption><span>task.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> schedule</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote, unquote</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">job</span><span class="params">(User,Pass)</span>:</span></span><br><span class="line">    base_url = <span class="string">'http://auth.dlut.edu.cn'</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        resp = requests.get(base_url)</span><br><span class="line">        print(<span class="string">"conneting..."</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="comment">#print("Already connected...")</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    query = resp.text[resp.text.find(<span class="string">'wlanuserip'</span>):resp.text.find(<span class="string">'&lt;/script&gt;'</span>)]</span><br><span class="line">    query_str = quote(quote(query))</span><br><span class="line"></span><br><span class="line">    url = base_url + <span class="string">'/eportal/InterFace.do?method=login'</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'userId'</span>: User,  <span class="comment"># username 1</span></span><br><span class="line">        <span class="string">'password'</span>: Pass,  <span class="comment"># password</span></span><br><span class="line">        <span class="string">'service'</span>: <span class="string">''</span>,  <span class="comment"># empty</span></span><br><span class="line">        <span class="string">'queryString'</span>: query_str,</span><br><span class="line">        <span class="string">'operatorPwd'</span>: <span class="string">''</span>,  <span class="comment"># empty</span></span><br><span class="line">        <span class="string">'operatorUserId'</span>: <span class="string">''</span>,  <span class="comment"># empty</span></span><br><span class="line">        <span class="string">'validcode'</span>: <span class="string">''</span>,  <span class="comment"># empty</span></span><br><span class="line">    &#125;</span><br><span class="line">    headers = &#123;<span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded; charset=UTF-8'</span>&#125;</span><br><span class="line">    resp = requests.post(url, data, headers=headers)</span><br><span class="line">    print(resp.status_code)</span><br><span class="line">    print(resp.text)</span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">'connect to dlut'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'-u'</span>,type=str, help=<span class="string">'user name'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'-p'</span>,type=str, help=<span class="string">'user name'</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line">User = args.u</span><br><span class="line">Pass = args.p</span><br><span class="line"></span><br><span class="line">job(User, Pass)</span><br><span class="line">schedule.every(<span class="number">300</span>).minutes.do(job,User,Pass)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    schedule.run_pending()</span><br><span class="line">    time.sleep(<span class="number">300</span>)</span><br></pre></td></tr></table></figure>
<p>其主要作用是进行认证链接,命令行调用格式为:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 task.py -u username -p passwd</span><br></pre></td></tr></table></figure></p>
<p>username是认证用户名，passwd是对应密码</p>
<h1 id="二、编写bash脚本调用登陆脚本"><a href="#二、编写bash脚本调用登陆脚本" class="headerlink" title="二、编写bash脚本调用登陆脚本"></a>二、编写bash脚本调用登陆脚本</h1><figure class="highlight bash"><figcaption><span>connect.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">python3 /home/sie/netset/task.py -u username  -p passwd &amp;</span><br><span class="line">``` </span><br><span class="line">添加可执行权限:</span><br><span class="line">``` bash</span><br><span class="line">chmod +x connect.sh</span><br></pre></td></tr></table></figure>
<p>将connect.sh和task.py都放到同一目录下 设为path_to_sp</p>
<h1 id="三、在-etc-rc-local里添加开机启动脚本命令"><a href="#三、在-etc-rc-local里添加开机启动脚本命令" class="headerlink" title="三、在/etc/rc.local里添加开机启动脚本命令"></a>三、在/etc/rc.local里添加开机启动脚本命令</h1><ul>
<li><p>配置rc-local.service服务使其能够执行开机启动脚本 <a href="https://www.cnblogs.com/defifind/p/9285456.html" target="_blank" rel="noopener">参考教程</a></p>
</li>
<li><p>root权限创建/etc/rc.local文件并写入开机启动的脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/sh -e</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># rc.local</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This script is executed at the end of each multiuser runlevel.</span></span><br><span class="line"><span class="comment"># Make sure that the script will "exit 0" on success or any other</span></span><br><span class="line"><span class="comment"># value on error.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In order to enable or disable this script just change the execution</span></span><br><span class="line"><span class="comment"># bits.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># By default this script does nothing.</span></span><br><span class="line">su -s /bin/sh sie -c<span class="string">"path_to_sp/connect.sh"</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>其中path_to_sp为connect.sh和task.py的目录</p>
<p>至此开机启动配置结束。</p>
<p>以前一直想搞定开机启动脚本的事情，但是总不得其要点，特此记录，以后还要多多了解原理才是。</p>

      
    </div>
</article>

    </li>
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/2019/05/07/服务器环境搭建ubuntu18-04-server-cuda10-1-cudann/">服务器环境搭建</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2019-05-07T03:27:14.000Z" itemprop="datePublished">
    2019-05-07
  </time>
  
  
</div>

    </header>
    <div>
      
        <p>ubuntu18.04-server<br>cuda10.1<br>cudann7.5.0</p>
<h1 id="安装显卡驱动"><a href="#安装显卡驱动" class="headerlink" title="安装显卡驱动"></a>安装显卡驱动</h1><ol>
<li><p>linux查看显卡型号</p>
<p> lshw -numeric -C display</p>
</li>
<li><p>下载nvidia官方驱动</p>
<p> <a href="https://www.geforce.cn/drivers" target="_blank" rel="noopener">官网链接</a></p>
</li>
<li><p>bios禁用禁用secure boot</p>
</li>
<li><p>禁用nouveau</p>
<p> 打开文件</p>
<pre><code>sudo vim /etc/modprobe.d/blacklist.conf
</code></pre><p> 在最后一行添加:</p>
<pre><code>blacklist nouveau
</code></pre><p> 执行如下命令生效</p>
<pre><code>sudo update-initramfs -u
</code></pre></li>
<li><p>重启</p>
<p> 使用命令查看nouveau有没有运行</p>
<pre><code>lsmod | grep nouveau  # 没输出代表禁用生效
</code></pre></li>
<li><p>停止可视化界面</p>
<pre><code>sudo telinit 3
</code></pre></li>
<li><p>安装驱动</p>
<p> 先添加可执行权限</p>
<pre><code>sudo chmod a+x filename.run
</code></pre><p> 执行安装：</p>
<pre><code>sudo ./filename.run -no-opengl-files
</code></pre><p> -noopengl-files这个参数一定要加，否则会循环登录</p>
</li>
</ol>
<h1 id="安装CUDA10-1"><a href="#安装CUDA10-1" class="headerlink" title="安装CUDA10.1"></a>安装CUDA10.1</h1><ol>
<li><p>下载cuda10.1安装文件 </p>
<p> <a href="https://developer.nvidia.com/cuda-downloads" target="_blank" rel="noopener">官网链接</a></p>
</li>
</ol>
<ol start="2">
<li><p>运行安装</p>
<p> 执行安装文件进行安装，同nvidia驱动的执行方式。</p>
<p> 注意此时不需要选择安装驱动。驱动版本要注意跟cuda版本相对应。</p>
</li>
</ol>
<h1 id="安装cudann"><a href="#安装cudann" class="headerlink" title="安装cudann"></a>安装cudann</h1><p>请见官网<a href="https://docs.nvidia.com/deeplearning/sdk/cudnn-install/index.html" target="_blank" rel="noopener">安装教程</a></p>

      
    </div>
</article>

    </li>
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/2019/04/09/OpenPose环境搭建笔记/">OpenPose环境搭建笔记</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2019-04-09T12:29:54.000Z" itemprop="datePublished">
    2019-04-09
  </time>
  
  
</div>

    </header>
    <div>
      
        <h1 id="OpenPose环境搭建笔记"><a href="#OpenPose环境搭建笔记" class="headerlink" title="OpenPose环境搭建笔记"></a>OpenPose环境搭建笔记</h1><h2 id="编译caffe"><a href="#编译caffe" class="headerlink" title="编译caffe"></a>编译caffe</h2><ul>
<li>recipe for target ‘.build_release/src/caffe/proto/caffe.pb.o’ failed</li>
</ul>
<p>参考教程：<br><a href="https://blog.csdn.net/w5688414/article/details/79478695" target="_blank" rel="noopener">https://blog.csdn.net/w5688414/article/details/79478695</a></p>
<ul>
<li>./include/caffe/util/hdf5.hpp:6:18: fatal error: hdf5.h: No such file or directory</li>
</ul>
<p>解决办法：在Makefile.config找到以下行并添加蓝色部分</p>
<p>INCLUDE_DIRS := $(PYTHON_INCLUDE) /usr/local/include /usr/include/hdf5/serial </p>
<p>LIBRARY_DIRS := $(PYTHON_LIB) /usr/local/lib /usr/lib /usr/lib/x86_64-Linux-gnu/hdf5/serial</p>
<p>3.1 如果仍然提示找不到lhdf5和lhdf5_hl(这是因为ubuntu16.04的文件包含位置发生了变化，尤其是需要用到的hdf5的位置，所以需要更改这一路径)选自<br>caffe —找不到lhdf5_hl和lhdf5的错误</p>
<p>解决办法：然后根据情况执行下面两句：</p>
<p>cd /usr/lib/x86_64-linux-gnu</p>
<p>sudo ln -s libhdf5_serial.so.10.1.0 libhdf5.so</p>
<p>sudo ln -s libhdf5_serial_hl.so.10.0.2 libhdf5_hl.so</p>
<ul>
<li><a href="https://github.com/BVLC/caffe/issues/6359" target="_blank" rel="noopener">https://github.com/BVLC/caffe/issues/6359</a></li>
</ul>
<p>/usr/include/c++/5/typeinfo:39:37: error: expected ‘}’ before end of line<br>/usr/include/c++/5/typeinfo:39:37: error: expected unqualified-id before end of line<br>/usr/include/c++/5/typeinfo:39:37: error: expected ‘}’ before end of line<br>/usr/include/c++/5/typeinfo:39:37: error: expected ‘}’ before end of line<br>/usr/include/c++/5/typeinfo:39:37: error: expected ‘}’ before end of line<br>/usr/include/c++/5/typeinfo:39:37: error: expected declaration before end of line<br>Makefile:588: recipe for target ‘.build_release/src/caffe/proto/caffe.pb.o’ failed<br>make: *** [.build_release/src/caffe/proto/caffe.pb.o] Error 1</p>
<p>CXXFLAGS += -pthread -fPIC $(COMMON_FLAGS) $(WARNINGS) -std=c++11<br>NVCCFLAGS += -D_FORCE_INLINES -ccbin=$(CXX) -Xcompiler -fPIC $(COMMON_FLAGS) -std=c++11<br>LINKFLAGS += -pthread -fPIC $(COMMON_FLAGS) $(WARNINGS) -std=c++11</p>
<ul>
<li>Unsupported gpu architecture ‘compute_20’</li>
</ul>
<p>注释Makefile.config 中 :</p>
<pre><code># CUDA architecture setting: going with all of them.
# For CUDA &lt; 6.0, comment the *_50 through *_61 lines for compatibility.
# For CUDA &lt; 8.0, comment the *_60 and *_61 lines for compatibility.
# For CUDA &gt;= 9.0, comment the *_20 and *_21 lines for compatibility.
CUDA_ARCH :=    -gencode arch=compute_30,code=sm_30 \
                -gencode arch=compute_35,code=sm_35 \
                -gencode arch=compute_50,code=sm_50 \
                -gencode arch=compute_52,code=sm_52 \
                -gencode arch=compute_60,code=sm_60 \
                -gencode arch=compute_61,code=sm_61 \
                -gencode arch=compute_61,code=compute_61
</code></pre><ul>
<li>leveldb<br><a href="https://blog.csdn.net/oeljeklaus/article/details/78802922" target="_blank" rel="noopener">https://blog.csdn.net/oeljeklaus/article/details/78802922</a></li>
</ul>
<p><a href="https://blog.csdn.net/fogxcg/article/details/75332146" target="_blank" rel="noopener">https://blog.csdn.net/fogxcg/article/details/75332146</a></p>
<ul>
<li>build opencv3.4</li>
</ul>
<p>cmake -D CMAKE_BUILD_TYPE=Release -D CMAKE_INSTALL_PREFIX=/usr/local -D PYTHON3_EXECUTABLE=/usr/bin/python3 -D PYTHON_INCLUDE_DIR=/us<br>r/include/python3 -D PYTHON_INCLUDE_DIR2=/usr/include/x86_64-linux-gnu/python3.5m -D PYTHON_LIBRARY=/usr/lib/x86_64-linux-gnu/libpython3.5m.so -D PYTHON3_NUMPY_INCLUDE_DIRS=/usr/lib/python3/dist-packages/numpy/core/include/ </p>
<ul>
<li>levelDB出错</li>
</ul>
<p><a href="https://blog.csdn.net/jyl1999xxxx/article/details/80583465" target="_blank" rel="noopener">https://blog.csdn.net/jyl1999xxxx/article/details/80583465</a></p>
<ul>
<li><p>glog 和 gflags 的安装<br><a href="https://www.cnblogs.com/burningTheStar/p/6986048.html" target="_blank" rel="noopener">https://www.cnblogs.com/burningTheStar/p/6986048.html</a><br>-fPIC<br><a href="https://github.com/BVLC/caffe/issues/2171" target="_blank" rel="noopener">https://github.com/BVLC/caffe/issues/2171</a></p>
</li>
<li><p>make runtest .build_release/tools/caffe: error while loading shared libraries: libopencv_imgcodecs.so.3.4: cannot open shared object file: No such file or directory<br>Makefile:542: recipe for target ‘runtest’ failed</p>
</li>
<li><p>make runtest <a href="https://blog.csdn.net/wonengguwozai/article/details/52724409" target="_blank" rel="noopener">https://blog.csdn.net/wonengguwozai/article/details/52724409</a></p>
</li>
</ul>
<h1 id="编译openpose"><a href="#编译openpose" class="headerlink" title="编译openpose"></a>编译openpose</h1><ul>
<li>cuda结构不共存 Unsupported gpu architecture ‘compute_xx’</li>
</ul>
<p>在cmake-gui 中选择 CUDA_ARCH 为mannul 然后再删掉其中不符合的结构</p>
<ul>
<li>g++: error trying to exec ‘cc1plus’: execvp: 没有那个文件或目录</li>
</ul>
<p>gcc g++ 版本不兼容 </p>
<p><a href="https://blog.csdn.net/yile0000/article/details/80105625" target="_blank" rel="noopener">https://blog.csdn.net/yile0000/article/details/80105625</a></p>
<p>nvidia驱动</p>
<p><a href="https://blog.csdn.net/wf19930209/article/details/81877822" target="_blank" rel="noopener">https://blog.csdn.net/wf19930209/article/details/81877822</a></p>
<p>sudo service lightdm stop</p>
<ul>
<li>gflags.cc is being linked both statically and dynamically </li>
</ul>
<p><a href="https://github.com/google/glog/issues/53" target="_blank" rel="noopener">https://github.com/google/glog/issues/53</a></p>
<p>修改CmakeCache.txt中的<br>GFLAGS_LIBRARY:FILEPATH=/usr/local/lib/libgflags.a<br>改为：<br>GFLAGS_LIBRARY:FILEPATH=/usr/local/lib/libgflags.so<br>然后重新编译</p>
<ul>
<li>[libprotobuf ERROR google/protobuf/message_lite.cc:123] Can’t parse message of type “caffe.NetParameter” because it is missing required fields: layer[0].clip_param.min, layer[0].clip_param.max</li>
</ul>
<p>要用openpose自带的caffe库</p>
<p>选择openpose编译caffe时选项可以在3rdparty/caffe中设置编译参数</p>

      
    </div>
</article>

    </li>
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/2018/12/31/使用python搭建小型搜索引擎/">使用python搭建小型搜索引擎</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2018-12-31T05:19:06.000Z" itemprop="datePublished">
    2018-12-31
  </time>
  
  | 
  <ul>
    
  <li class="meta-text">
  { <a href="/tags/Django/">Django</a> }
  </li>

  <li class="meta-text">
  { <a href="/tags/Python/">Python</a> }
  </li>

  <li class="meta-text">
  { <a href="/tags/Scrapy/">Scrapy</a> }
  </li>

  <li class="meta-text">
  { <a href="/tags/Haystack/">Haystack</a> }
  </li>

  <li class="meta-text">
  { <a href="/tags/Whoosh/">Whoosh</a> }
  </li>

  <li class="meta-text">
  { <a href="/tags/Jieba/">Jieba</a> }
  </li>


  </ul>
  
  
  / 
  <ul>
    
  <li class="meta-text">
  { <a href="/categories/项目总结/">项目总结</a> }
  </li>


  </ul>
  
</div>

    </header>
    <div>
      
        <p><a href="https://github.com/HaxiSnake/EXERCISE/tree/master/others/homework/MessageRetrieval/SearchEngine" target="_blank" rel="noopener">项目代码链接</a></p>
<h1 id="一、目标"><a href="#一、目标" class="headerlink" title="一、目标"></a>一、目标</h1><p>为准备信息检索课程的期末大作业，因此我使用python搭建了一个小型的搜索引擎，其功能是检索<a href="http://news.dlut.edu.cn/" target="_blank" rel="noopener">大工新闻网</a>的新闻。</p>
<h1 id="二、原理和工具简介"><a href="#二、原理和工具简介" class="headerlink" title="二、原理和工具简介"></a>二、原理和工具简介</h1><h2 id="2-1-原理"><a href="#2-1-原理" class="headerlink" title="2.1 原理"></a>2.1 原理</h2><p>该搜索引擎的原理是采用scrapy对大工新闻网进行爬虫，提取出文字新闻，并将新闻内容存入数据库A，再利用Django框架搭建一个搜索服务器，在服务器上部署Haystack+Whoosh搜索引擎，使用jieba分词工具来进行中文分词和停用词过滤。通过搜索引擎工具建立索引文件后，在前端完成用户交互界面，实现一个完整的小型搜索引擎。</p>
<h2 id="2-2-工具简介"><a href="#2-2-工具简介" class="headerlink" title="2.2 工具简介"></a>2.2 工具简介</h2><ul>
<li><p>Scrapy </p>
<p>  Python开发的一个快速、高层次的屏幕抓取和web抓取框架，用于抓取web站点并从页面中提取结构化的数据。Scrapy用途广泛，可以用于数据挖掘、监测和自动化测试。</p>
<p>  在本项目中用来爬取网站数据。</p>
</li>
<li><p>Django</p>
<p>  Django是一个开放源代码的Web应用框架，由Python写成。采用了MVC的框架模式，即模型M，视图V和控制器C。</p>
<p>  在本项目用来做搜索服务器的框架。</p>
</li>
<li><p>Haystack+Whoosh</p>
<p>  Haystack是一个Django上的应用，可以用于整合搜索引擎，它只依赖于它自身的代码，利用它可以切换不同的搜索引擎工具。Whoosh是一个索引文本和搜索文本的类库，它可以提供搜索文本的服务。</p>
<p>  在本项目中使用Haystack将Whoosh部署到Django服务器作为搜索引擎后端。</p>
</li>
<li><p>Jieba</p>
<p>  Jieba是一个python实现的分词库，对中文有着很强大的分词能力。</p>
<p>  在本项目用于对新闻进行中文分词和停用词过滤。</p>
</li>
</ul>
<h1 id="三、开发环境和运行环境"><a href="#三、开发环境和运行环境" class="headerlink" title="三、开发环境和运行环境"></a>三、开发环境和运行环境</h1><h2 id="3-1-开发环境"><a href="#3-1-开发环境" class="headerlink" title="3.1 开发环境"></a>3.1 开发环境</h2><ul>
<li>win 10 </li>
<li>python 3.6.5  </li>
<li>scrapy 1.5.1 <a href="https://www.cnblogs.com/MC-Curry/p/8503813.html" target="_blank" rel="noopener">安装教程</a></li>
<li>Django 2.1.3 <a href="https://docs.djangoproject.com/zh-hans/2.1/howto/windows/" target="_blank" rel="noopener">安装教程</a></li>
<li>Haystack+Whoosh <a href="https://django-haystack.readthedocs.io/en/master/tutorial.html" target="_blank" rel="noopener">配置教程</a></li>
<li>Jieba 0.39 <a href="https://blog.csdn.net/yx1179109710/article/details/81304036" target="_blank" rel="noopener">配置教程</a></li>
</ul>
<h2 id="3-2-运行环境"><a href="#3-2-运行环境" class="headerlink" title="3.2 运行环境"></a>3.2 运行环境</h2><p>同开发环境</p>
<h1 id="四、系统模块"><a href="#四、系统模块" class="headerlink" title="四、系统模块"></a>四、系统模块</h1><h2 id="4-1-网络爬虫模块"><a href="#4-1-网络爬虫模块" class="headerlink" title="4.1 网络爬虫模块"></a>4.1 网络爬虫模块</h2><h3 id="定义用于Scrapy爬虫的数据类型，包括链接、标题和文章内容"><a href="#定义用于Scrapy爬虫的数据类型，包括链接、标题和文章内容" class="headerlink" title="定义用于Scrapy爬虫的数据类型，包括链接、标题和文章内容:"></a>定义用于Scrapy爬虫的数据类型，包括链接、标题和文章内容:</h3><pre><code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NewsItem</span><span class="params">(scrapy.Item)</span>:</span></span><br><span class="line">    url = scrapy.Field() </span><br><span class="line">    title = scrapy.Field()</span><br><span class="line">    content = scrapy.Field()</span><br></pre></td></tr></table></figure>
</code></pre><h3 id="编写爬虫策略"><a href="#编写爬虫策略" class="headerlink" title="编写爬虫策略:"></a>编写爬虫策略:</h3><p>爬虫策略的制定依据于网页源代码的链接形式，由于要爬取的是文字类新闻，所以要跟进与文字类新闻的链接。对于具体的新闻页利用回调函数爬取其链接、标题和内容。而对于新闻列表页，需要跟进下一页的链接。具体规则代码如下:</p>
<pre><code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NewsSpider</span><span class="params">(CrawlSpider)</span>:</span></span><br><span class="line">    print(<span class="string">"news spider starting"</span>)</span><br><span class="line">    name = <span class="string">'news'</span></span><br><span class="line">    allowed_domains = [<span class="string">'news.dlut.edu.cn'</span>]</span><br><span class="line">    start_urls = [<span class="string">'http://news.dlut.edu.cn/'</span>]</span><br><span class="line"></span><br><span class="line">    rules = (</span><br><span class="line">        <span class="comment"># 对于新闻页链接进行跟进</span></span><br><span class="line">        Rule(LinkExtractor(allow=(<span class="string">"xw/[a-z]+.htm"</span>))),</span><br><span class="line">        <span class="comment"># 对于详细新闻页利用parse_item回调函数进行内容爬取</span></span><br><span class="line">        Rule(LinkExtractor(allow=(<span class="string">"info/\d&#123;4,&#125;/\d&#123;3,&#125;\.htm"</span>)),callback=<span class="string">"parse_item"</span>),</span><br><span class="line">        <span class="comment"># 对于新闻列表中的下一页链接进行跟进</span></span><br><span class="line">        Rule(LinkExtractor(allow=(<span class="string">"\d&#123;1,&#125;.htm"</span>),restrict_xpaths=<span class="string">"//a[@class='Next']"</span>)),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_item</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        self.log(<span class="string">"Hi, this is a new page! %s"</span>% response.url)</span><br><span class="line">        item = NewsItem()</span><br><span class="line">        item[<span class="string">'title'</span>] = response.xpath(<span class="string">'/html/head/title/text()'</span>).extract()[<span class="number">0</span>]</span><br><span class="line">        item[<span class="string">'url'</span>] = response.url</span><br><span class="line">        item[<span class="string">'content'</span>]=response.xpath(<span class="string">"//div[@class='cont-detail fs-small']/p/text()"</span>).extract()</span><br><span class="line">        <span class="keyword">yield</span> item</span><br></pre></td></tr></table></figure>
</code></pre><h3 id="使用pipline机制将数据保存至数据库当中"><a href="#使用pipline机制将数据保存至数据库当中" class="headerlink" title="使用pipline机制将数据保存至数据库当中"></a>使用pipline机制将数据保存至数据库当中</h3><pre><code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpiderprojectPipeline</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_item</span><span class="params">(self, item, spider)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> spider.name == <span class="string">'news'</span>:</span><br><span class="line">            conn = sqlite3.connect(<span class="string">'db.sqlite3'</span>) </span><br><span class="line">            cursor = conn.cursor()</span><br><span class="line">            title = item[<span class="string">'title'</span>]</span><br><span class="line">            url = item[<span class="string">'url'</span>]</span><br><span class="line">            content_tmp = item[<span class="string">'content'</span>]</span><br><span class="line">            content=<span class="string">""</span></span><br><span class="line">            <span class="keyword">for</span> p <span class="keyword">in</span> content_tmp:</span><br><span class="line">                content+=p.strip()</span><br><span class="line">            sql_search = <span class="string">'select arturl from search_article where arturl=="%s"'</span> % (url) </span><br><span class="line">            sql = <span class="string">'insert into articles_article(title, content, arturl) values("%s", "%s", "%s")'</span>%(title, content, url)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment">#如果当前数据库中不存在该条新闻，则将新闻保存至数据库当中</span></span><br><span class="line">                cursor.execute(sql_search)</span><br><span class="line">                result_search = cursor.fetchone()</span><br><span class="line">                <span class="keyword">if</span> result_search <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or</span> result_search[<span class="number">0</span>].strip()==<span class="string">''</span>:</span><br><span class="line">                    cursor.execute(sql)</span><br><span class="line">                    result=cursor.fetchone()</span><br><span class="line">                    conn.commit()</span><br><span class="line">                cursor.execute(sql)</span><br><span class="line">                result=cursor.fetchone()</span><br><span class="line">                conn.commit()</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                print(<span class="string">"&gt;&gt;&gt; catch exception !"</span>)</span><br><span class="line">                print(e)</span><br><span class="line">                conn.rollback()</span><br><span class="line">        <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure>
</code></pre><h2 id="4-2-搜索模块"><a href="#4-2-搜索模块" class="headerlink" title="4.2 搜索模块"></a>4.2 搜索模块</h2><p>在要进行搜索的应用的models.py文件中建立model类用来表示要进行搜索的新闻文章</p>
<pre><code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">50</span>)</span><br><span class="line">    arturl = models.CharField(max_length=<span class="number">200</span>)</span><br><span class="line">    content = models.CharField(max_length=<span class="number">1000</span>)</span><br></pre></td></tr></table></figure>
</code></pre><p>同时使用django命令<code>python manage.py makemigrations</code>和<code>python manage.py migrate</code>生成数据库文件，并用爬虫得到的数据库替换生成的数据库。</p>
<p>在django框架中配置Haystack+Whoosh来引入搜索模块</p>
<pre><code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置搜索引擎后端</span></span><br><span class="line">HAYSTACK_CONNECTIONS=&#123;</span><br><span class="line">    <span class="string">'default'</span>:&#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'articles.whoosh_cn_backend.WhooshEngine'</span>,</span><br><span class="line">        <span class="comment"># 索引文件路径</span></span><br><span class="line">        <span class="string">'PATH'</span>: os.path.join(BASE_DIR, <span class="string">'whoosh_index'</span>),  <span class="comment"># 在项目目录下创建文件夹 whoosh_index</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 当添加、修改、删除数据时，自动生成索引</span></span><br><span class="line">HAYSTACK_SIGNAL_PROCESSOR = <span class="string">'haystack.signals.RealtimeSignalProcessor'</span></span><br><span class="line"><span class="comment"># 每页显示十条搜索结果</span></span><br><span class="line">HAYSTACK_SEARCH_RESULTS_PER_PAGE = <span class="number">10</span></span><br></pre></td></tr></table></figure>
</code></pre><p>在要进行搜索的应用的目录下建立search_indexes.py文件</p>
<pre><code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> haystack <span class="keyword">import</span> indexes</span><br><span class="line"><span class="keyword">from</span> articles.models <span class="keyword">import</span> Article</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleIndex</span><span class="params">(indexes.SearchIndex, indexes.Indexable)</span>:</span>     <span class="comment">#类名必须为需要检索的Model_name+Index，这里需要检索Article，所以创建ArticleIndex</span></span><br><span class="line">    text = indexes.CharField(document=<span class="keyword">True</span>, use_template=<span class="keyword">True</span>)  <span class="comment">#创建一个text字段</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_model</span><span class="params">(self)</span>:</span>          <span class="comment">#重载get_model方法，必须要有！</span></span><br><span class="line">        <span class="keyword">return</span> Article</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">index_queryset</span><span class="params">(self, using=None)</span>:</span>   <span class="comment">#重载index_..函数</span></span><br><span class="line">        <span class="string">"""Used when the entire index for model is updated."""</span></span><br><span class="line">        <span class="keyword">return</span> self.get_model().objects.all()</span><br></pre></td></tr></table></figure>
</code></pre><p>在articles\templates\search\indexes\articles\下建立article_text.txt文件确定搜索内容</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; object.title &#125;&#125;</span><br><span class="line">&#123;&#123; object.content &#125;&#125;</span><br><span class="line">&#123;&#123; object.url &#125;&#125;</span><br></pre></td></tr></table></figure>
</code></pre><h2 id="4-2-预处理模块"><a href="#4-2-预处理模块" class="headerlink" title="4.2 预处理模块"></a>4.2 预处理模块</h2><p>使用jieba来进行中文分词，需要在whoosh_cn_backend文件中替换StemmingAnalyzer为ChineseAnalyzer</p>
<p>同时引入停用词表，配置ChineseAnalyzer使其支持停用词过滤</p>
<pre><code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># 导入停用词过滤表</span></span><br><span class="line">stop_file_dir=os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line">STOP_WORDS = frozenset([line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> open(os.path.join(stop_file_dir, <span class="string">'stop.txt'</span>),<span class="string">'r'</span>,encoding=<span class="string">'gbk'</span>).readlines()])</span><br><span class="line"></span><br><span class="line">accepted_chars = re.compile(<span class="string">r"[\u4E00-\u9FD5]+"</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChineseTokenizer</span><span class="params">(Tokenizer)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, text, **kargs)</span>:</span></span><br><span class="line">        words = jieba.tokenize(text, mode=<span class="string">"search"</span>)</span><br><span class="line">        token = Token()</span><br><span class="line">        <span class="keyword">for</span> (w, start_pos, stop_pos) <span class="keyword">in</span> words:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> accepted_chars.match(w) <span class="keyword">and</span> len(w) &lt;= <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            token.original = token.text = w</span><br><span class="line">            token.pos = start_pos</span><br><span class="line">            token.startchar = start_pos</span><br><span class="line">            token.endchar = stop_pos</span><br><span class="line">            <span class="keyword">yield</span> token</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ChineseAnalyzer</span><span class="params">(stoplist=STOP_WORDS, minsize=<span class="number">1</span>, stemfn=stem, cachesize=<span class="number">50000</span>)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> (ChineseTokenizer() | LowercaseFilter() |</span><br><span class="line">                StopFilter(stoplist=stoplist, minsize=minsize) |</span><br><span class="line">                StemFilter(stemfn=stemfn, ignore=<span class="keyword">None</span>, cachesize=cachesize))</span><br></pre></td></tr></table></figure>
</code></pre><p>配置完成后使用<code>python manage.py rebuild_index</code>建立搜索索引</p>
<h2 id="4-4-交互模块"><a href="#4-4-交互模块" class="headerlink" title="4.4 交互模块"></a>4.4 交互模块</h2><p>搜索首页html关键代码：</p>
<pre><code><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">'get'</span> <span class="attr">action</span>=<span class="string">"/search/"</span> <span class="attr">target</span>=<span class="string">"_blank"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"q"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"查询"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
</code></pre><p>首页如下图所示：<br><img src="/2018/12/31/使用python搭建小型搜索引擎/query.jpg" title="image"></p>
<p>查询结果页html关键代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load highlight %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>搜索&amp;nbsp;<span class="tag">&lt;<span class="name">b</span>&gt;</span>&#123;&#123;query&#125;&#125;<span class="tag">&lt;/<span class="name">b</span>&gt;</span>&amp;nbsp;结果如下：<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">&#123;%for item in page%&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123;item.object.title|safe&#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;% highlight item.object.content with query %&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123;item.object.arturl&#125;&#125;"</span>&gt;</span>&#123;&#123;item.object.arturl&#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">&#123;%empty%&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>啥也没找到<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">&#123;%endfor%&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">&#123;%for pindex in page.paginator.page_range%&#125;</span><br><span class="line">    &#123;%if pindex == page.number%&#125;</span><br><span class="line">        &#123;&#123;pindex&#125;&#125;&amp;nbsp;&amp;nbsp;</span><br><span class="line">    &#123;%else%&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"?q=&#123;&#123;query&#125;&#125;&amp;amp;page=&#123;&#123;pindex&#125;&#125;"</span>&gt;</span>&#123;&#123;pindex&#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span>&amp;nbsp;&amp;nbsp;</span><br><span class="line">    &#123;%endif%&#125;</span><br><span class="line">&#123;%endfor%&#125;</span><br></pre></td></tr></table></figure>
<p>其中使用</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load highlight %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;% highlight item.object.content with query %&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>进行搜索结果的高亮显示</p>
<p>最终搜索页面如下图所示：</p>
<img src="/2018/12/31/使用python搭建小型搜索引擎/search.jpg" title="image">
<h1 id="五、项目代码"><a href="#五、项目代码" class="headerlink" title="五、项目代码"></a>五、项目代码</h1><p><a href="https://github.com/HaxiSnake/EXERCISE/tree/master/homework/MessageRetrieval/SearchEngine" target="_blank" rel="noopener">代码链接</a></p>

      
    </div>
</article>

    </li>
  
</ul>

  <section id="nav-wrapper">
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">next »</a>
    </nav>
  </section>


            <footer>
    <div>© 2020 - HaxiSnake </div>
    <div>
        <span>
            Powered by <a href="https://hexo.io">Hexo</a>
        </span>
        ,
        <span>
            Theme - <a href="https://github.com/nameoverflow/hexo-theme-icalm">Icalm</a>
        </span>
    </div>
</footer>

        </div>
    </div>
</div>
<script src="/js/pager/dist/singlepager.js"></script>
<script>
var sp = new Pager('data-pager-shell')

</script>
</body>
</html>